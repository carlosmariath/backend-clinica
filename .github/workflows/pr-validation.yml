name: ðŸ” PR Validation

on:
  pull_request:
    branches: [main, master, develop, staging]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  # ============= VALIDAÃ‡ÃƒO DE PR =============
  pr-validation:
    name: ðŸ” PR Quality Check
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ” Lint check
        run: npm run lint
        
      - name: ðŸ’… Format check
        run: npm run format -- --check
        
      - name: ðŸ—ï¸ Build check
        run: npm run build
        
      - name: ðŸ—„ï¸ Database migration check
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
        run: |
          npx prisma migrate deploy
          npx prisma generate
          
      - name: ðŸ§ª Run tests
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
          JWT_SECRET: test-secret
        run: |
          npm run test
          npm run test:e2e
          
      - name: ðŸ”’ Security check
        run: npm audit --audit-level=moderate
        continue-on-error: true
        
      - name: ðŸ“ Check bundle size
        run: |
          npm run build
          echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          du -h dist/ >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“Š PR Summary Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Ler resultados dos testes (se existir)
            let testResults = '';
            try {
              testResults = fs.readFileSync('test-results.txt', 'utf8');
            } catch (e) {
              testResults = 'Testes executados com sucesso âœ…';
            }
            
            const comment = `
            ## ðŸ” PR Validation Results
            
            ### âœ… Quality Checks
            - ðŸ” **Lint:** Passed
            - ðŸ’… **Format:** Passed  
            - ðŸ—ï¸ **Build:** Passed
            - ðŸ—„ï¸ **Database:** Migrations OK
            - ðŸ§ª **Tests:** ${testResults}
            - ðŸ”’ **Security:** Scanned
            
            ### ðŸ“¦ Build Information
            - **Node Version:** ${process.env.NODE_VERSION}
            - **Bundle Size:** Generated successfully
            - **Database Schema:** Valid
            
            > This PR is ready for review! ðŸš€
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============= ANÃLISE DE MUDANÃ‡AS =============
  change-analysis:
    name: ðŸ“ˆ Change Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“Š Analyze changes
        run: |
          echo "## ðŸ“ˆ Change Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Files Changed:" >> $GITHUB_STEP_SUMMARY
          git diff --name-only origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY
          
          echo "### Lines Changed:" >> $GITHUB_STEP_SUMMARY
          git diff --stat origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY
          
          # Verificar se hÃ¡ mudanÃ§as no schema do banco
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "prisma/schema.prisma"; then
            echo "âš ï¸ **Database schema changes detected!**" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure migrations are included." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Verificar se hÃ¡ mudanÃ§as em dependÃªncias
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "package.json"; then
            echo "ðŸ“¦ **Package.json changes detected!**" >> $GITHUB_STEP_SUMMARY
            echo "Dependencies may have changed." >> $GITHUB_STEP_SUMMARY
          fi